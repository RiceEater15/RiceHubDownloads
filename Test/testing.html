<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>IPA Signer Test</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 2rem;
    background: #f9f9f9;
  }
  #uploadArea {
    border: 2px dashed #ccc;
    padding: 2rem;
    text-align: center;
    margin-bottom: 1rem;
    cursor: pointer;
  }
  #uploadArea.dragover {
    border-color: #0088ff;
    background-color: #e0f0ff;
  }
  #uploadProgress {
    display: none;
    margin-bottom: 1rem;
  }
  #progressBar {
    width: 100%;
    background: #ddd;
    height: 20px;
    border-radius: 10px;
    overflow: hidden;
  }
  #progressFill {
    background: #0088ff;
    width: 0%;
    height: 100%;
    transition: width 0.3s;
  }
  #uploadResults {
    margin-top: 1rem;
  }
  .upload-result-item {
    background: white;
    border: 1px solid #ccc;
    margin-bottom: 1rem;
    padding: 1rem;
    border-radius: 6px;
    display: flex;
    align-items: center;
    gap: 1rem;
  }
  .upload-result-icon {
    font-size: 2rem;
  }
  .upload-result-info {
    flex: 1;
  }
  .upload-result-status.error {
    color: red;
  }
  select#certs {
    margin-top: 0.5rem;
  }
  button#sign_button {
    margin-top: 0.5rem;
    padding: 0.4rem 0.8rem;
    cursor: pointer;
  }
</style>
</head>
<body>

<h1>IPA Signer Test Upload</h1>

<div id="uploadArea">Drag & Drop IPA here or click to select</div>
<input type="file" id="fileInput" multiple accept=".ipa" style="display:none" />

<div id="uploadProgress">
  <div id="progressBar">
    <div id="progressFill"></div>
  </div>
  <div id="progressText"></div>
</div>

<div id="uploadResults"></div>

<script>
  const fileInput = document.getElementById('fileInput');
  const uploadArea = document.getElementById('uploadArea');
  const uploadProgress = document.getElementById('uploadProgress');
  const progressFill = document.getElementById('progressFill');
  const progressText = document.getElementById('progressText');
  const uploadResults = document.getElementById('uploadResults');

  // iOS check disables drag-drop
  function isIOS() {
    return /iPad|iPhone|iPod/.test(navigator.userAgent) ||
           (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
  }

  if (!isIOS()) {
    uploadArea.addEventListener('dragover', e => {
      e.preventDefault();
      uploadArea.classList.add('dragover');
    });

    uploadArea.addEventListener('dragleave', e => {
      e.preventDefault();
      uploadArea.classList.remove('dragover');
    });

    uploadArea.addEventListener('drop', e => {
      e.preventDefault();
      uploadArea.classList.remove('dragover');
      const files = Array.from(e.dataTransfer.files).filter(f => f.name.endsWith('.ipa'));
      if (files.length) handleFileUpload(files);
    });
  }

  uploadArea.addEventListener('click', () => fileInput.click());

  fileInput.addEventListener('change', e => {
    const files = Array.from(e.target.files);
    if (files.length) handleFileUpload(files);
  });

  function handleFileUpload(files) {
    uploadResults.innerHTML = '';
    uploadProgress.style.display = 'block';
    progressFill.style.width = '0%';
    progressText.textContent = 'Preparing upload...';

    const formData = new FormData();
    files.forEach(file => formData.append('files[]', file));

    const xhr = new XMLHttpRequest();

    xhr.upload.addEventListener('progress', e => {
      if (e.lengthComputable) {
        const percent = (e.loaded / e.total) * 100;
        progressFill.style.width = percent + '%';
        progressText.textContent = `Uploading... ${Math.round(percent)}%`;
      }
    });

    xhr.addEventListener('load', () => {
      uploadProgress.style.display = 'none';
      if (xhr.status === 200) {
        try {
          const response = JSON.parse(xhr.responseText);
          if(Array.isArray(response)) {
            response.forEach(item => {
              showUploadResult('✅', item.name || 'Unknown', 'Uploaded', 'success', item.id || '');
            });
          } else {
            showUploadResult('❌', 'Upload Error', 'Unexpected response format', 'error');
          }
        } catch {
          showUploadResult('❌', 'Server Error', 'Invalid JSON response', 'error');
        }
      } else {
        showUploadResult('❌', 'Upload Failed', `Server returned ${xhr.status}`, 'error');
      }
    });

    xhr.addEventListener('error', () => {
      uploadProgress.style.display = 'none';
      showUploadResult('❌', 'Network Error', 'Failed to connect to server', 'error');
    });

    // TODO: Adjust the upload URL to your actual upload_ipa.php endpoint
    xhr.open('POST', 'upload_ipa.php');
    xhr.send(formData);
  }

  function showUploadResult(icon, name, status, type, id) {
    const resultItem = document.createElement('div');
    resultItem.className = 'upload-result-item';
    resultItem.innerHTML = `
      <div class="upload-result-icon">${icon}</div>
      <div class="upload-result-info">
        <div class="upload-result-name">${name}</div>
        <div class="upload-result-status ${type}">${status}</div>
        ${id ? `
        <select name="certs" id="certs">
          <option value="5">TCL1</option>
          <option value="6">TCL2</option>
          <option value="7">TCL3</option>
          <option value="8">TCL4</option>
          <option value="9">TCL5</option>
          <option value="1">WULIN</option>
          <option value="2">EEO1</option>
          <option value="3">EEO2</option>
          <option value="4">EEO3</option>
        </select>
        <button onclick="sign('${id}')" id="sign_button">Sign</button>
        ` : ''}
      </div>
    `;
    uploadResults.appendChild(resultItem);
  }

  async function sign(id) {
    const select = document.querySelector(`#uploadResults select[name=certs]`);
    if (!select) {
      alert("Certificate selector not found.");
      return;
    }
    const selectedCert = select.value;
    const signButton = document.getElementById("sign_button");
    if (!signButton) {
      alert("Sign button not found.");
      return;
    }

    select.style.display = "none";
    signButton.style.display = "none";
    signButton.innerText = "Signing...";

    try {
      const response = await fetch(`https://skibiditech.co/sign.php?app=${encodeURIComponent(id)}&cert=${encodeURIComponent(selectedCert)}&rid=${Math.random()}`, {
        method: "POST"
      });

      const json = await response.json();

      if (json.state) {
        signButton.style.display = "block";
        signButton.innerText = "Install";
        signButton.onclick = () => {
          const manifestUrl = `https://skibiditech.co/generate_plist.php?app=${encodeURIComponent(id)}&rid=${Math.random()}`;
          const a = document.createElement("a");
          a.href = `itms-services://?action=download-manifest&url=${encodeURIComponent(manifestUrl)}`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
        };
      } else {
        alert("Signing failed: " + json.state);
        select.style.display = "block";
        signButton.style.display = "block";
        signButton.innerText = "Sign";
      }
    } catch (error) {
      alert("Error during signing: " + error.message);
      select.style.display = "block";
      signButton.style.display = "block";
      signButton.innerText = "Sign";
    }
  }
</script>

</body>
</html>
